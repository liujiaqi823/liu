<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QGIS Cloud åœ°å›¾åº”ç”¨</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 300px;
    }
    #panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background: white;
      border-left: 1px solid #ccc;
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .chart-container {
      height: 200px;
      margin-top: 20px;
    }
    button, input, select {
      margin: 5px 0;
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
  <h3>åœ°å›¾æ§åˆ¶é¢æ¿</h3>

  <label>å›¾å±‚åˆ‡æ¢:</label>
  <select id="layerSelect">
    <option value="wms">QGIS Cloud åœ°å›¾</option>
    <option value="osm">OpenStreetMap</option>
  </select>

  <p>ğŸ‘‰ ç‚¹å‡»åœ°å›¾æ·»åŠ  Marker</p>

  <label>å‘¨è¾¹æœç´¢åŠå¾„ (ç±³):</label>
  <input type="number" id="radiusInput" value="1000" min="100" max="10000" />

  <button id="searchBtn">æ‰§è¡Œå‘¨è¾¹æœç´¢</button>
  <button id="clearBtn">æ¸…é™¤ç»“æœ</button>

  <div class="chart-container">
    <canvas id="statChart"></canvas>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // ======================
  // åˆå§‹åŒ–åœ°å›¾ï¼ˆæ ¹æ®ä½ çš„ extent è°ƒæ•´åˆå§‹è§†å›¾ï¼‰
  // e=12536866,4646864,13440153,5131051 æ˜¯ Web Mercator åæ ‡ (EPSG:3857)
  // è½¬æ¢ä¸ºç»çº¬åº¦å¤§çº¦æ˜¯ï¼šä¸œç» 112.7Â° ï½ 120.8Â°ï¼ŒåŒ—çº¬ 38.5Â° ï½ 42.5Â°
  // ä¸­å¿ƒç‚¹å– (40.5, 116.7) é™„è¿‘
  // ======================
  const map = L.map('map').setView([40.5, 116.7], 8);

  // OpenStreetMap å›¾å±‚
  const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  });

  // âœ… ä½ çš„ QGIS Cloud WMS å›¾å±‚ï¼ˆä½¿ç”¨æ­£ç¡®åŸŸåï¼‰
  const qgisWmsLayer = L.tileLayer.wms('https://wms.qgiscloud.com/yuxi/1/', {
    layers: '3,2,1',        // å¯¹åº” l=3%2C2%2C1
    format: 'image/png',
    transparent: true,
    version: '1.3.0',       // æ¨èä½¿ç”¨ 1.3.0ï¼ˆæ”¯æŒ EPSG:3857ï¼‰
    crs: L.CRS.EPSG3857,    // æ˜¾å¼æŒ‡å®šåæ ‡ç³»
    attribution: 'Â© QGIS Cloud'
  });

  let currentBaseLayer = qgisWmsLayer.addTo(map);

  // å›¾å±‚åˆ‡æ¢
  document.getElementById('layerSelect').addEventListener('change', function(e) {
    map.removeLayer(currentBaseLayer);
    currentBaseLayer = e.target.value === 'wms' ? qgisWmsLayer : osmLayer;
    map.addLayer(currentBaseLayer);
  });

  // ======================
  // ç‚¹å‡»æ·»åŠ  Marker
  // ======================
  let markers = [];
  let circleBuffer = null;

  map.on('click', function(e) {
    const marker = L.marker(e.latlng).addTo(map);
    marker.bindPopup(`<b>ä½ç½®:</b><br>çº¬åº¦: ${e.latlng.lat.toFixed(5)}<br>ç»åº¦: ${e.latlng.lng.toFixed(5)}`)
           .openPopup();
    markers.push(marker);
  });

  // ======================
  // å‘¨è¾¹æœç´¢ + æœåŠ¡åŠå¾„åˆ†æ
  // ======================
  document.getElementById('searchBtn').addEventListener('click', function() {
    if (markers.length === 0) {
      alert('è¯·å…ˆç‚¹å‡»åœ°å›¾æ·»åŠ ä¸€ä¸ªä¸­å¿ƒç‚¹ï¼');
      return;
    }

    const center = markers[markers.length - 1].getLatLng();
    const radius = parseFloat(document.getElementById('radiusInput').value);

    if (circleBuffer) map.removeLayer(circleBuffer);

    circleBuffer = L.circle(center, {
      radius: radius,
      color: '#ff7800',
      fillColor: '#ff7800',
      fillOpacity: 0.2
    }).addTo(map);

    // æ›´æ–°ç»Ÿè®¡å›¾
    updateChart();
  });

  document.getElementById('clearBtn').addEventListener('click', function() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    if (circleBuffer) {
      map.removeLayer(circleBuffer);
      circleBuffer = null;
    }
    if (window.myChart) window.myChart.destroy();
  });

  // ======================
  // ç»Ÿè®¡å›¾ï¼ˆæŸ±çŠ¶å›¾ï¼‰
  // ======================
  function updateChart() {
    const ctx = document.getElementById('statChart').getContext('2d');
    if (window.myChart) window.myChart.destroy();

    window.myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['é¤é¥®', 'é›¶å”®', 'åŒ»ç–—', 'æ•™è‚²', 'äº¤é€š'],
        datasets: [{
          label: 'POI æ•°é‡',
          data: [12, 8, 5, 3, 7],
          backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true } }
      }
    });
  }

</script>

</body>
</html>